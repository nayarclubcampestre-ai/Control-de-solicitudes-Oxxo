<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Solicitudes OXXO</title>
    <style>
        :root {
            --color-white: rgba(255, 255, 255, 1);
            --color-black: rgba(0, 0, 0, 1);
            --color-cream-50: rgba(252, 252, 249, 1);
            --color-cream-100: rgba(255, 255, 253, 1);
            --color-gray-200: rgba(245, 245, 245, 1);
            --color-gray-300: rgba(167, 169, 169, 1);
            --color-gray-400: rgba(119, 124, 124, 1);
            --color-slate-500: rgba(98, 108, 113, 1);
            --color-brown-600: rgba(94, 82, 64, 1);
            --color-charcoal-700: rgba(31, 33, 33, 1);
            --color-charcoal-800: rgba(38, 40, 40, 1);
            --color-slate-900: rgba(19, 52, 59, 1);
            --color-teal-300: rgba(50, 184, 198, 1);
            --color-teal-400: rgba(45, 166, 178, 1);
            --color-teal-500: rgba(33, 128, 141, 1);
            --color-teal-600: rgba(29, 116, 128, 1);
            --color-teal-700: rgba(26, 104, 115, 1);
            --color-red-400: rgba(255, 84, 89, 1);
            --color-red-500: rgba(192, 21, 47, 1);
            --color-orange-400: rgba(230, 129, 97, 1);
            --color-orange-500: rgba(168, 75, 47, 1);
            --color-brown-600-rgb: 94, 82, 64;
            --color-teal-500-rgb: 33, 128, 141;
            --color-slate-900-rgb: 19, 52, 59;
            --color-slate-500-rgb: 98, 108, 113;
            --color-red-500-rgb: 192, 21, 47;
            --color-red-400-rgb: 255, 84, 89;
            --color-orange-500-rgb: 168, 75, 47;
            --color-orange-400-rgb: 230, 129, 97;
            --color-background: var(--color-cream-50);
            --color-surface: var(--color-cream-100);
            --color-text: var(--color-slate-900);
            --color-text-secondary: var(--color-slate-500);
            --color-primary: var(--color-teal-500);
            --color-primary-hover: var(--color-teal-600);
            --color-primary-active: var(--color-teal-700);
            --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
            --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
            --color-secondary-active: rgba(var(--color-brown-600-rgb), 0.25);
            --color-border: rgba(var(--color-brown-600-rgb), 0.2);
            --color-btn-primary-text: var(--color-cream-50);
            --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
            --color-error: var(--color-red-500);
            --color-success: var(--color-teal-500);
            --color-warning: var(--color-orange-500);
            --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);
            --font-family-base: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            --radius-base: 8px;
            --radius-lg: 12px;
            --space-8: 8px;
            --space-12: 12px;
            --space-16: 16px;
            --space-20: 20px;
            --space-24: 24px;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --color-gray-400-rgb: 119, 124, 124;
                --color-teal-300-rgb: 50, 184, 198;
                --color-gray-300-rgb: 167, 169, 169;
                --color-gray-200-rgb: 245, 245, 245;
                --color-background: var(--color-charcoal-700);
                --color-surface: var(--color-charcoal-800);
                --color-text: var(--color-gray-200);
                --color-text-secondary: rgba(var(--color-gray-300-rgb), 0.7);
                --color-primary: var(--color-teal-300);
                --color-primary-hover: var(--color-teal-400);
                --color-secondary: rgba(var(--color-gray-400-rgb), 0.15);
                --color-secondary-hover: rgba(var(--color-gray-400-rgb), 0.25);
                --color-border: rgba(var(--color-gray-400-rgb), 0.3);
                --color-error: var(--color-red-400);
                --color-success: var(--color-teal-300);
                --color-warning: var(--color-orange-400);
                --color-btn-primary-text: var(--color-slate-900);
                --color-card-border: rgba(var(--color-gray-400-rgb), 0.2);
                --color-focus-ring: rgba(var(--color-teal-300-rgb), 0.4);
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family-base);
            background-color: var(--color-background);
            color: var(--color-text);
            line-height: 1.5;
            padding: var(--space-20);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            margin-bottom: var(--space-24);
            text-align: center;
        }

        .header-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-16);
            margin-bottom: var(--space-16);
        }

        .header-logo img {
            max-width: 120px;
            height: auto;
        }

        .subtitle {
            font-size: 0.875rem;
            color: var(--color-text-secondary);
            letter-spacing: 0.12em;
            text-transform: uppercase;
        }

        h1 {
            font-size: 2rem;
            color: var(--color-text);
            margin-bottom: var(--space-8);
        }

        .header-stats {
            display: flex;
            gap: var(--space-16);
            justify-content: center;
            flex-wrap: wrap;
            margin-top: var(--space-16);
        }

        .stat-card {
            background: var(--color-surface);
            padding: var(--space-12) var(--space-20);
            border-radius: var(--radius-base);
            border: 1px solid var(--color-card-border);
            box-shadow: var(--shadow-sm);
        }

        .stat-number {
            font-size: 1.75rem;
            font-weight: 600;
            color: var(--color-primary);
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--color-text-secondary);
        }

        .main-layout {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: var(--space-24);
            margin-bottom: var(--space-24);
        }

        @media (max-width: 968px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-card-border);
            box-shadow: var(--shadow-md);
            padding: var(--space-24);
        }

        .card h2 {
            font-size: 1.25rem;
            margin-bottom: var(--space-20);
            color: var(--color-text);
        }

        .form-group {
            margin-bottom: var(--space-16);
        }

        label {
            display: block;
            margin-bottom: var(--space-8);
            font-weight: 500;
            font-size: 0.875rem;
            color: var(--color-text);
        }

        input, select, textarea {
            width: 100%;
            padding: var(--space-8) var(--space-12);
            font-size: 0.875rem;
            line-height: 1.5;
            color: var(--color-text);
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            font-family: var(--font-family-base);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        input:focus, select:focus, textarea:focus {
            outline: 2px solid var(--color-primary);
            border-color: var(--color-primary);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-8) var(--space-16);
            border-radius: var(--radius-base);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--color-primary);
            color: var(--color-btn-primary-text);
            width: 100%;
        }

        .btn-primary:hover {
            background: var(--color-primary-hover);
        }

        .btn-secondary {
            background: var(--color-secondary);
            color: var(--color-text);
        }

        .btn-secondary:hover {
            background: var(--color-secondary-hover);
        }

        .btn-small {
            padding: 4px 12px;
            font-size: 0.75rem;
        }

        .filters {
            display: flex;
            gap: var(--space-8);
            flex-wrap: wrap;
            margin-bottom: var(--space-20);
        }

        .filter-btn {
            padding: var(--space-8) var(--space-12);
            border-radius: var(--radius-base);
            border: 1px solid var(--color-border);
            background: var(--color-surface);
            color: var(--color-text);
            font-size: 0.813rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            background: var(--color-secondary-hover);
        }

        .filter-btn.active {
            background: var(--color-primary);
            color: var(--color-btn-primary-text);
            border-color: var(--color-primary);
        }

        .solicitud-item {
            background: var(--color-surface);
            border: 1px solid var(--color-card-border);
            border-radius: var(--radius-base);
            padding: var(--space-16);
            margin-bottom: var(--space-12);
            transition: all 0.2s;
        }

        .solicitud-item:hover {
            box-shadow: var(--shadow-md);
        }

        .solicitud-item.urgente {
            border-left: 4px solid var(--color-error);
        }

        .solicitud-item.normal {
            border-left: 4px solid var(--color-warning);
        }

        .solicitud-item.completado {
            opacity: 0.6;
            border-left: 4px solid var(--color-success);
        }

        .solicitud-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-8);
        }

        .solicitud-title {
            font-weight: 600;
            font-size: 1rem;
            color: var(--color-text);
        }

        .badges {
            display: flex;
            gap: var(--space-8);
            flex-wrap: wrap;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge-urgente {
            background: rgba(var(--color-red-500-rgb), 0.15);
            color: var(--color-error);
            border: 1px solid rgba(var(--color-red-500-rgb), 0.25);
        }

        .badge-normal {
            background: rgba(var(--color-orange-500-rgb), 0.15);
            color: var(--color-warning);
            border: 1px solid rgba(var(--color-orange-500-rgb), 0.25);
        }

        .badge-local {
            background: rgba(var(--color-teal-500-rgb), 0.15);
            color: var(--color-success);
            border: 1px solid rgba(var(--color-teal-500-rgb), 0.25);
        }

        .badge-foranea {
            background: rgba(var(--color-slate-500-rgb), 0.15);
            color: var(--color-text-secondary);
            border: 1px solid rgba(var(--color-slate-500-rgb), 0.25);
        }

        .solicitud-meta {
            font-size: 0.813rem;
            color: var(--color-text-secondary);
            margin-bottom: var(--space-8);
        }

        .solicitud-description {
            font-size: 0.875rem;
            color: var(--color-text);
            margin-bottom: var(--space-12);
        }

        .solicitud-actions {
            display: flex;
            gap: var(--space-8);
            flex-wrap: wrap;
        }

        .export-section {
            margin-top: var(--space-24);
            text-align: center;
        }

        .empty-state {
            text-align: center;
            padding: var(--space-24);
            color: var(--color-text-secondary);
        }

        .success-message {
            background: rgba(var(--color-teal-500-rgb), 0.15);
            color: var(--color-success);
            padding: var(--space-12);
            border-radius: var(--radius-base);
            margin-bottom: var(--space-16);
            display: none;
        }

        .search-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: var(--radius-base);
            border: 1px solid var(--color-border);
            background: var(--color-surface);
            margin-bottom: var(--space-16);
        }

        .search-bar input {
            border: none;
            outline: none;
            flex: 1;
            font-size: 0.875rem;
            background: transparent;
            color: var(--color-text);
        }

        .search-icon {
            font-size: 0.9rem;
            color: var(--color-text-secondary);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-logo">
                <img src="https://agi-prod-file-upload-public-main-use1.s3.amazonaws.com/0c15824a-03e7-4cea-b289-07269e0983ef" alt="Logo LJIF">
                <div>
                    <h1>Control de Solicitudes OXXO</h1>
                    <p class="subtitle">LJIF Log√≠stica y Soluciones</p>
                </div>
            </div>
            <div class="header-stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalSolicitudes">0</div>
                    <div class="stat-label">Total Solicitudes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalUrgentes">0</div>
                    <div class="stat-label">Urgentes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalPendientes">0</div>
                    <div class="stat-label">Pendientes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalCompletados">0</div>
                    <div class="stat-label">Completados</div>
                </div>
            </div>
        </header>

        <div class="main-layout">
            <div class="card">
                <h2>‚ûï Nueva Solicitud</h2>
                <div class="success-message" id="successMessage">
                    ‚úì Solicitud registrada exitosamente
                </div>
                <form id="solicitudForm">
                    <div class="form-group">
                        <label for="numTienda">Seleccionar Tienda</label>
                        <input type="text" id="numTienda" placeholder="Buscar tienda por c√≥digo o nombre..." autocomplete="off" required>
                        <div id="tiendaSuggestions" style="display: none; position: absolute; z-index: 1000; background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-base); max-height: 200px; overflow-y: auto; width: calc(100% - 48px); box-shadow: var(--shadow-md);"></div>
                        <input type="hidden" id="numTiendaData" required>
                    </div>

                    <div class="form-group">
                        <label for="tipoRequerimiento">Tipo de Requerimiento</label>
                        <select id="tipoRequerimiento" required>
                            <option value="">Seleccionar...</option>
                            <option value="Promocionales">Art√≠culos Promocionales</option>
                            <option value="Lonas">Lonas Publicitarias</option>
                            <option value="Porta Etiquetas">Porta Etiquetas de Precios</option>
                            <option value="Mobiliario">Movimiento de Mobiliario</option>
                            <option value="Folios Promoxxo">Atenci√≥n de Folios de Promoxxo</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="zona">Zona</label>
                        <select id="zona" required>
                            <option value="">Seleccionar...</option>
                            <option value="Local">Local</option>
                            <option value="For√°nea">For√°nea</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="responsable">Responsable asignado</label>
                        <select id="responsable" required>
                            <option value="">Seleccionar...</option>
                        </select>
                        <small style="color: var(--color-text-secondary); font-size: 0.75rem; display: block; margin-top: 4px;">
                            Se asigna autom√°ticamente seg√∫n la zona de la solicitud.
                        </small>
                    </div>

                    <div class="form-group">
                        <label for="prioridad">Prioridad</label>
                        <select id="prioridad" required>
                            <option value="">Seleccionar...</option>
                            <option value="Urgente">Urgente</option>
                            <option value="Normal">Normal</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="descripcion">Descripci√≥n del Requerimiento</label>
                        <textarea id="descripcion" required></textarea>
                    </div>

                    <div class="form-group">
                        <label for="solicitante">Solicitante</label>
                        <input type="text" id="solicitante" placeholder="Nombre del solicitante" required>
                    </div>

                    <div class="form-group">
                        <label for="fechaLimite">Fecha L√≠mite</label>
                        <input type="date" id="fechaLimite">
                    </div>

                    <div class="form-group">
                        <label for="notas">Notas Adicionales</label>
                        <textarea id="notas" placeholder="Informaci√≥n adicional o comentarios..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="evidencia">Evidencia Fotogr√°fica</label>
                        <input type="file" id="evidencia" accept="image/*" multiple>
                        <small style="color: var(--color-text-secondary); font-size: 0.75rem; display: block; margin-top: 4px;">Puedes seleccionar m√∫ltiples im√°genes</small>
                    </div>

                    <button type="submit" class="btn btn-primary">Registrar Solicitud</button>
                </form>
            </div>

            <div class="card">
                <h2>üìã Solicitudes Registradas</h2>
                
                <div class="search-bar">
                    <span class="search-icon">üîç</span>
                    <input type="text" id="searchInput" placeholder="Buscar por tienda, tipo o solicitante...">
                </div>
                
                <div class="filters">
                    <button class="filter-btn active" data-filter="all">Todas</button>
                    <button class="filter-btn" data-filter="urgente">Solo Urgentes</button>
                    <button class="filter-btn" data-filter="local">Zona Local</button>
                    <button class="filter-btn" data-filter="foranea">Zona For√°nea</button>
                    <button class="filter-btn" data-filter="pendientes">Solo Pendientes</button>
                    <button class="filter-btn" data-filter="promocionales">Promocionales</button>
                    <button class="filter-btn" data-filter="lonas">Lonas</button>
                    <button class="filter-btn" data-filter="portaetiquetas">Porta Etiquetas</button>
                    <button class="filter-btn" data-filter="mobiliario">Mobiliario</button>
                    <button class="filter-btn" data-filter="folios">Folios Promoxxo</button>
                </div>

                <div id="solicitudesList">
                    <div class="empty-state">
                        No hay solicitudes registradas. Crea la primera usando el formulario.
                    </div>
                </div>
            </div>
        </div>

        <div class="export-section">
            <button class="btn btn-secondary" id="exportBtn">üì• Exportar a Excel/CSV</button>
        </div>
    </div>

    <!-- Modal de seguimiento -->
    <div id="seguimientoModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.35); z-index:2000; align-items:center; justify-content:center;">
        <div style="background:var(--color-surface); border-radius:var(--radius-lg); padding:20px; max-width:500px; width:90%; box-shadow:var(--shadow-md);">
            <h3 style="margin-bottom:12px;">Agregar evidencia de trabajo realizado</h3>
            <div class="form-group">
                <label for="seguimientoNotas">Notas de seguimiento</label>
                <textarea id="seguimientoNotas" placeholder="Describe el avance o trabajo realizado..."></textarea>
            </div>
            <div class="form-group">
                <label for="seguimientoFotos">Fotograf√≠as de evidencia</label>
                <input type="file" id="seguimientoFotos" accept="image/*" multiple>
            </div>
            <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:12px;">
                <button class="btn btn-secondary btn-small" onclick="cerrarSeguimiento()">Cancelar</button>
                <button class="btn btn-primary btn-small" onclick="guardarSeguimiento()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- SCRIPT PRINCIPAL + FIREBASE -->
    <script type="module">
        /***** Firebase imports *****/
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
        import { 
            getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc 
        } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

        /***** Firebase config (TU PROYECTO) *****/
        const firebaseConfig = {
          apiKey: "AIzaSyDH26nHHnUgWBMZvtZXOgLoaFou5u4Fdto",
          authDomain: "solicitudes-oxxo-jf-5a1d9.firebaseapp.com",
          projectId: "solicitudes-oxxo-jf-5a1d9",
          storageBucket: "solicitudes-oxxo-jf-5a1d9.firebasestorage.app",
          messagingSenderId: "590888537867",
          appId: "1:590888537867:web:a8f1261f45b02b7c579c0e",
          measurementId: "G-T00XWZCQ76"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const solicitudesRef = collection(db, "solicitudes");

        /***** C√≥digo de la app *****/
        const tiendas = [
            {codigo: '50TPE', nombre: 'Tepic-Mexico GDL', zona: 'Local'},
            {codigo: '50VKG', nombre: 'Tepic JuanEscutiaGDL', zona: 'Local'},
            {codigo: '50SCI', nombre: 'Tepic Calle 2 GDL', zona: 'For√°nea'},
            {codigo: '50K7O', nombre: 'Tepic La Presa GDL', zona: 'For√°nea'},
            {codigo: '50TKN', nombre: 'Tepic Penas GDL', zona: 'For√°nea'},
            {codigo: '50U57', nombre: 'Tepic Xalisco Las Lomas GDL', zona: 'Local'},
            {codigo: '50CIA', nombre: 'Tepic Zaragoza GDL', zona: 'Local'},
            {codigo: '50PSX', nombre: 'Tepic El Hule GDL', zona: 'Local'},
            {codigo: '50UYK', nombre: 'Tepic Amapa GDL', zona: 'Local'},
            {codigo: '50WN1', nombre: 'Tepic Abastos GDL', zona: 'Local'},
            {codigo: '50ZHW', nombre: 'Parque la loma', zona: 'Local'},
            {codigo: '50NBX', nombre: 'Tepic Leon GDL', zona: 'Local'},
            {codigo: '50QMZ', nombre: 'Tepic-Cd.delasArtes GDL', zona: 'Local'},
            {codigo: '50RHM', nombre: 'Tepic ROMANO GDL', zona: 'Local'},
            {codigo: '50UXG', nombre: 'Tepic Ejercito GDL', zona: 'Local'},
            {codigo: '501YO', nombre: 'Tepic Crucero San Blas II GDL', zona: 'For√°nea'},
            {codigo: '50QP8', nombre: 'Tepic San Blas Crucero GDL', zona: 'For√°nea'},
            {codigo: '50YXT', nombre: 'Tepic-Alameda GDL', zona: 'Local'},
            {codigo: '50OIV', nombre: 'Tepic Malecon Aticama GDL', zona: 'Local'},
            {codigo: '500SD', nombre: 'Tepic Flores Magon GDL', zona: 'Local'},
            {codigo: '50765', nombre: 'Tepic Miramar GDL', zona: 'Local'},
            {codigo: '509A0', nombre: 'Tepic Jalcocotan GDL', zona: 'Local'},
            {codigo: '50DVV', nombre: 'TepicMontesdeAlaska', zona: 'Local'},
            {codigo: '50FC9', nombre: 'San Blas Muelle GDL', zona: 'For√°nea'},
            {codigo: '50FYQ', nombre: 'Tepic Allende GDL', zona: 'Local'},
            {codigo: '50TBT', nombre: 'Tepic Bucerias GDL', zona: 'For√°nea'},
            {codigo: '50VST', nombre: 'TepicSeguroSocialGDL', zona: 'Local'},
            {codigo: '50R5G', nombre: 'San Blas Las Islitas GDL', zona: 'For√°nea'},
            {codigo: '50JHH', nombre: 'Tepic Roble GDL', zona: 'Local'},
            {codigo: '50GBP', nombre: 'Tepic Naya GDL', zona: 'Local'},
            {codigo: '50HHA', nombre: 'Tepic Pza.XaliscoGDL', zona: 'Local'},
            {codigo: '50QP1', nombre: 'Tepic KM 100 GDL', zona: 'Local'},
            {codigo: '50TKB', nombre: 'Tepic Gavilan GDL', zona: 'Local'},
            {codigo: '50C2K', nombre: 'Tepic El Pedregal GDL', zona: 'Local'},
            {codigo: '50CLS', nombre: 'Tepic CentroCarret.GDL', zona: 'Local'},
            {codigo: '50ROU', nombre: 'Tepic Brasil GDL', zona: 'Local'},
            {codigo: '50YWQ', nombre: 'Tepic-Banderas GDL', zona: 'For√°nea'},
            {codigo: '502HU', nombre: 'Tepic Jacarandas GDL', zona: 'Local'},
            {codigo: '500JF', nombre: 'Tepic Tuxpan Bordo', zona: 'For√°nea'},
            {codigo: '50ZOV', nombre: 'Tepic Tuxpan Hospital GDL', zona: 'For√°nea'},
            {codigo: '50L7K', nombre: 'Tepic Tuxpan Mercado', zona: 'For√°nea'},
            {codigo: '50ZQV', nombre: 'Tepic Tuxpan', zona: 'For√°nea'},
            {codigo: '500R3', nombre: 'Tepic San Blas Centro GDL', zona: 'For√°nea'},
            {codigo: '502RJ', nombre: 'Tepic Santiago Zona Militar GDL', zona: 'For√°nea'},
            {codigo: '5030Z', nombre: 'Tepic Villa Talpita GDL', zona: 'For√°nea'},
            {codigo: '509L1', nombre: 'Tepic Santiago Jimenez GDL', zona: 'For√°nea'},
            {codigo: '50CHU', nombre: 'Tepic San Blas GDL', zona: 'For√°nea'},
            {codigo: '50J7I', nombre: 'Tepic San Blas Gpe Victoria Gdl', zona: 'For√°nea'},
            {codigo: '50JQB', nombre: 'Tepic Santiago GDL', zona: 'For√°nea'},
            {codigo: '500NH', nombre: 'TepicSantiagoHos GDL', zona: 'For√°nea'},
            {codigo: '50TB6', nombre: 'SAN BLAS LA MARINA', zona: 'For√°nea'},
            {codigo: '50UM4', nombre: 'ESTACION VICTORIA', zona: 'For√°nea'},
            {codigo: '50UXD', nombre: 'T.Santiago CentroGDL', zona: 'For√°nea'},
            {codigo: '50VXQ', nombre: 'Tepic-VillaHigo GDL', zona: 'For√°nea'},
            {codigo: '50XTY', nombre: 'Tepic Yago GDL', zona: 'For√°nea'},
            {codigo: '507Q7', nombre: 'Tepic Ruiz Mercado GDL', zona: 'For√°nea'},
            {codigo: '50UFY', nombre: 'Tepic Ruiz GDL', zona: 'For√°nea'},
            {codigo: '50Y2D', nombre: 'Tepic Ruiz Tijuanita GDL', zona: 'For√°nea'},
            {codigo: '504KT', nombre: 'Tepic las Penitas GDL', zona: 'For√°nea'},
            {codigo: '50HOJ', nombre: 'TepicBvd.XaliscoGDL', zona: 'Local'},
            {codigo: '50WHP', nombre: 'Tepic Saturno GDL', zona: 'Local'},
            {codigo: '50NOJ', nombre: 'Tepic Solidaridad GDL', zona: 'Local'},
            {codigo: '50CA6', nombre: 'Tecuala Oriente', zona: 'For√°nea'},
            {codigo: '500G7', nombre: 'San Vicente', zona: 'For√°nea'},
            {codigo: '50WO6', nombre: 'Tepic Colinas Xalisco GDL', zona: 'Local'},
            {codigo: '50QHR', nombre: 'Tepic-AcaponetaCtoGDL', zona: 'For√°nea'},
            {codigo: '507IA', nombre: 'TepicPlazaLeonesGDL', zona: 'For√°nea'},
            {codigo: '501HV', nombre: 'Tepic Tecuala Centro GDL', zona: 'For√°nea'},
            {codigo: '50SCV3', nombre: 'Tepic-Tecuala GDL', zona: 'For√°nea'},
            {codigo: '50RNJ', nombre: 'Tepic Acaponeta GDL', zona: 'For√°nea'},
            {codigo: '504XZ', nombre: 'Tepic Rosamorada GDL', zona: 'For√°nea'},
            {codigo: '504RX', nombre: 'Tepic Mexcalitan GDL', zona: 'For√°nea'},
            {codigo: '50DT0', nombre: 'Tepic Acaponeta el Molino', zona: 'For√°nea'},
            {codigo: '50EF6', nombre: 'Tepic Acaponeta Morelos', zona: 'For√°nea'},
            {codigo: '50CY3', nombre: 'Tepic Acaponeta Mercado GDL', zona: 'For√°nea'},
            {codigo: '50X4H', nombre: 'Tepic Acaponeta Santuario GDL', zona: 'For√°nea'},
            {codigo: '50IN1', nombre: 'TEPIC NOVILLERO GDL', zona: 'For√°nea'},
            {codigo: '50IY1', nombre: 'Matanchen', zona: 'For√°nea'},
            {codigo: '508BQ', nombre: 'TEPIC HUAJICORI', zona: 'For√°nea'},
            {codigo: '506NT', nombre: 'Tepic San Felipe Aztatlan', zona: 'For√°nea'},
            {codigo: '500U3', nombre: 'Tepic El Progreso Xalisco GDL', zona: 'Local'},
            {codigo: '50S5T', nombre: 'Tepic Tecolote', zona: 'Local'},
            {codigo: '506O2', nombre: 'De Guadalupe', zona: 'For√°nea'},
            {codigo: '506O2', nombre: 'Tecuala Caseta', zona: 'For√°nea'},
            {codigo: '500Z1', nombre: 'Tecuala Gemela', zona: 'For√°nea'},
            {codigo: '50EP', nombre: 'Tuxpan centro', zona: 'For√°nea'},
            {codigo: '503JL', nombre: 'Santiago Zaragoza', zona: 'For√°nea'}
        ];

        let solicitudes = [];
        let currentFilter = 'all';
        let selectedTiendaData = null;
        let solicitudEnSeguimiento = null;

        const responsablesLocales = [
            'Victor Salazar',
            'Marco Antonio Orozco',
            'Diana Bautista'
        ];

        const responsableForaneo = 'Allan Marco Perez';

        function setupTiendaAutocomplete() {
            const input = document.getElementById('numTienda');
            const hiddenInput = document.getElementById('numTiendaData');
            const suggestionsDiv = document.getElementById('tiendaSuggestions');

            input.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase().trim();
                
                if (searchTerm.length === 0) {
                    suggestionsDiv.style.display = 'none';
                    hiddenInput.value = '';
                    selectedTiendaData = null;
                    return;
                }

                const filtered = tiendas.filter(tienda => 
                    tienda.codigo.toLowerCase().includes(searchTerm) ||
                    tienda.nombre.toLowerCase().includes(searchTerm)
                );

                if (filtered.length === 0) {
                    suggestionsDiv.style.display = 'none';
                    return;
                }

                suggestionsDiv.innerHTML = filtered.map(tienda => `
                    <div style="padding: 8px 12px; cursor: pointer; border-bottom: 1px solid var(--color-border);" 
                         onmouseover="this.style.backgroundColor='var(--color-secondary)'" 
                         onmouseout="this.style.backgroundColor='transparent'"
                         onclick="window.selectTienda('${tienda.codigo}', '${tienda.nombre.replace(/'/g, "\\'")}', '${tienda.zona}')">
                        <strong>${tienda.codigo}</strong> - ${tienda.nombre}
                    </div>
                `).join('');

                suggestionsDiv.style.display = 'block';
            });

            input.addEventListener('blur', function() {
                setTimeout(() => {
                    suggestionsDiv.style.display = 'none';
                }, 200);
            });
        }

        window.selectTienda = function(codigo, nombre, zona) {
            const input = document.getElementById('numTienda');
            const hiddenInput = document.getElementById('numTiendaData');
            const suggestionsDiv = document.getElementById('tiendaSuggestions');
            
            selectedTiendaData = {codigo, nombre, zona};
            input.value = `${codigo} - ${nombre}`;
            hiddenInput.value = JSON.stringify(selectedTiendaData);
            suggestionsDiv.style.display = 'none';
        };

        function actualizarResponsablePorZona() {
            const zonaSelect = document.getElementById('zona');
            const responsableSelect = document.getElementById('responsable');
            
            responsableSelect.innerHTML = '<option value="">Seleccionar...</option>';
            
            if (zonaSelect.value === 'For√°nea') {
                const opt = document.createElement('option');
                opt.value = responsableForaneo;
                opt.textContent = responsableForaneo;
                responsableSelect.appendChild(opt);
                responsableSelect.value = responsableForaneo;
            } else if (zonaSelect.value === 'Local') {
                responsablesLocales.forEach(nombre => {
                    const opt = document.createElement('option');
                    opt.value = nombre;
                    opt.textContent = nombre;
                    responsableSelect.appendChild(opt);
                });
            }
        }

        function loadSolicitudesLocal() {
            const stored = localStorage.getItem('solicitudesOXXO');
            if (stored) {
                solicitudes = JSON.parse(stored);
            }
        }

        function saveSolicitudesLocal() {
            localStorage.setItem('solicitudesOXXO', JSON.stringify(solicitudes));
        }

        async function loadSolicitudesFirestore() {
            solicitudes = [];
            const snapshot = await getDocs(solicitudesRef);
            snapshot.forEach(d => {
                const data = d.data();
                solicitudes.push({
                    ...data,
                    id: data.id || d.id
                });
            });
        }

        async function saveSolicitudFirestore(solicitud) {
            if (typeof solicitud.id === "string") {
                const ref = doc(db, "solicitudes", solicitud.id);
                await updateDoc(ref, solicitud);
            } else {
                const ref = await addDoc(solicitudesRef, solicitud);
                solicitud.id = ref.id;
            }
        }

        async function updateCampoFirestore(id, campos) {
            if (typeof id !== "string") return;
            const ref = doc(db, "solicitudes", id);
            await updateDoc(ref, campos);
        }

        async function deleteSolicitudFirestore(id) {
            if (typeof id !== "string") return;
            const ref = doc(db, "solicitudes", id);
            await deleteDoc(ref);
        }

        function updateStats() {
            const total = solicitudes.length;
            const urgentes = solicitudes.filter(s => s.prioridad === 'Urgente' && s.estado === 'Pendiente').length;
            const pendientes = solicitudes.filter(s => s.estado === 'Pendiente').length;
            const completados = solicitudes.filter(s => s.estado === 'Completado').length;

            document.getElementById('totalSolicitudes').textContent = total;
            document.getElementById('totalUrgentes').textContent = urgentes;
            document.getElementById('totalPendientes').textContent = pendientes;
            document.getElementById('totalCompletados').textContent = completados;
        }

        function renderSolicitudes(searchTerm = '') {
            const container = document.getElementById('solicitudesList');
            
            let filtered = solicitudes;

            if (searchTerm) {
                filtered = filtered.filter(s => 
                    (s.codigoTienda || '').toLowerCase().includes(searchTerm) ||
                    (s.nombreTienda || '').toLowerCase().includes(searchTerm) ||
                    (s.tipo || '').toLowerCase().includes(searchTerm) ||
                    (s.solicitante && s.solicitante.toLowerCase().includes(searchTerm)) ||
                    (s.descripcion || '').toLowerCase().includes(searchTerm)
                );
            }

            if (currentFilter === 'urgente') {
                filtered = filtered.filter(s => s.prioridad === 'Urgente' && s.estado === 'Pendiente');
            } else if (currentFilter === 'local') {
                filtered = filtered.filter(s => s.zona === 'Local');
            } else if (currentFilter === 'foranea') {
                filtered = filtered.filter(s => s.zona === 'For√°nea');
            } else if (currentFilter === 'pendientes') {
                filtered = filtered.filter(s => s.estado === 'Pendiente');
            } else if (currentFilter === 'promocionales') {
                filtered = filtered.filter(s => s.tipo === 'Promocionales');
            } else if (currentFilter === 'lonas') {
                filtered = filtered.filter(s => s.tipo === 'Lonas');
            } else if (currentFilter === 'portaetiquetas') {
                filtered = filtered.filter(s => s.tipo === 'Porta Etiquetas');
            } else if (currentFilter === 'mobiliario') {
                filtered = filtered.filter(s => s.tipo === 'Mobiliario');
            } else if (currentFilter === 'folios') {
                filtered = filtered.filter(s => s.tipo === 'Folios Promoxxo');
            }

            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state">No hay solicitudes que coincidan con el filtro seleccionado.</div>';
                return;
            }

            const sortedSolicitudes = [...filtered].sort((a, b) => {
                if (a.estado === 'Completado' && b.estado === 'Pendiente') return 1;
                if (a.estado === 'Pendiente' && b.estado === 'Completado') return -1;
                if (a.prioridad === 'Urgente' && b.prioridad === 'Normal') return -1;
                if (a.prioridad === 'Normal' && b.prioridad === 'Urgente') return 1;
                return (b.fechaTimestamp || 0) - (a.fechaTimestamp || 0);
            });

            container.innerHTML = sortedSolicitudes.map(sol => `
                <div class="solicitud-item ${sol.prioridad.toLowerCase()} ${sol.estado.toLowerCase()}">
                    <div class="solicitud-header">
                        <div class="solicitud-title">${sol.codigoTienda} - ${sol.nombreTienda} - ${sol.tipo}</div>
                        <div class="badges">
                            <span class="badge badge-${sol.prioridad.toLowerCase()}">${sol.prioridad}</span>
                            <span class="badge badge-${sol.zona.toLowerCase()}">${sol.zona}</span>
                        </div>
                    </div>
                    <div class="solicitud-meta">
                        üìÖ ${sol.fecha} ‚Ä¢ Estado: ${sol.estado}
                        ${sol.solicitante ? ' ‚Ä¢ üë§ ' + sol.solicitante : ''}
                        ${sol.responsable ? ' ‚Ä¢ üßë‚Äçüíº ' + sol.responsable : ''}
                        ${sol.fechaLimite && sol.fechaLimite !== 'Sin fecha l√≠mite' ? ' ‚Ä¢ ‚è∞ ' + sol.fechaLimite : ''}
                    </div>
                    <div class="solicitud-description">
                        ${sol.descripcion}
                        ${sol.notas ? '<br><em style="color: var(--color-text-secondary); font-size: 0.813rem;">Notas: ' + sol.notas + '</em>' : ''}
                        ${sol.evidencias && sol.evidencias.length > 0 ? '<br><div style="margin-top: 8px;"><strong>üì∏ Evidencias (' + sol.evidencias.length + '):</strong><br>' + sol.evidencias.map((ev, idx) => `<img src="${ev}" alt="Evidencia ${idx + 1}" style="max-width: 150px; max-height: 150px; margin: 4px; border-radius: 4px; cursor: pointer;" onclick="window.open('${ev}', '_blank')">`).join('') + '</div>' : ''}
                    </div>
                    <div class="solicitud-actions">
                        <button class="btn btn-secondary btn-small" onclick="abrirSeguimiento('${sol.id}')">‚úèÔ∏è Agregar Evidencia</button>
                        ${sol.estado === 'Pendiente' ? 
                            `<button class="btn btn-secondary btn-small" onclick="completarSolicitud('${sol.id}')">‚úì Marcar Completado</button>` : 
                            `<button class="btn btn-secondary btn-small" onclick="reactivarSolicitud('${sol.id}')">‚Üª Reactivar</button>`
                        }
                        <button class="btn btn-secondary btn-small" onclick="eliminarSolicitud('${sol.id}')">üóë Eliminar</button>
                    </div>
                </div>
            `).join('');
        }

        window.abrirSeguimiento = function(id) {
            solicitudEnSeguimiento = solicitudes.find(s => String(s.id) === String(id));
            if (!solicitudEnSeguimiento) return;
            document.getElementById('seguimientoNotas').value = '';
            document.getElementById('seguimientoFotos').value = '';
            document.getElementById('seguimientoModal').style.display = 'flex';
        };

        window.cerrarSeguimiento = function() {
            solicitudEnSeguimiento = null;
            document.getElementById('seguimientoModal').style.display = 'none';
        };

        window.guardarSeguimiento = async function() {
            if (!solicitudEnSeguimiento) return;

            const notas = document.getElementById('seguimientoNotas').value.trim();
            const fileInput = document.getElementById('seguimientoFotos');
            const nuevasEvidencias = [];

            const procesarArchivosSeguimiento = () => {
                return new Promise(resolve => {
                    if (fileInput.files.length === 0) {
                        resolve([]);
                        return;
                    }
                    let processed = 0;
                    Array.from(fileInput.files).forEach(file => {
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            nuevasEvidencias.push(event.target.result);
                            processed++;
                            if (processed === fileInput.files.length) {
                                resolve(nuevasEvidencias);
                            }
                        };
                        reader.readAsDataURL(file);
                    });
                });
            };

            const imagenesBase64 = await procesarArchivosSeguimiento();

            if (!solicitudEnSeguimiento.seguimiento) {
                solicitudEnSeguimiento.seguimiento = [];
            }

            solicitudEnSeguimiento.seguimiento.push({
                fecha: new Date().toLocaleString('es-MX'),
                notas,
                evidencias: imagenesBase64
            });

            if (!solicitudEnSeguimiento.evidencias) {
                solicitudEnSeguimiento.evidencias = [];
            }
            solicitudEnSeguimiento.evidencias = solicitudEnSeguimiento.evidencias.concat(imagenesBase64);

            saveSolicitudesLocal();
            try {
                await saveSolicitudFirestore(solicitudEnSeguimiento);
            } catch (e) {
                console.error(e);
            }
            updateStats();
            renderSolicitudes(document.getElementById('searchInput').value.toLowerCase());
            window.cerrarSeguimiento();
        };

        window.completarSolicitud = async function(id) {
            const solicitud = solicitudes.find(s => String(s.id) === String(id));
            if (!solicitud) return;
            solicitud.estado = 'Completado';
            saveSolicitudesLocal();
            try {
                await updateCampoFirestore(solicitud.id, { estado: 'Completado' });
            } catch (e) {
                console.error(e);
            }
            updateStats();
            renderSolicitudes(document.getElementById('searchInput').value.toLowerCase());
        };

        window.reactivarSolicitud = async function(id) {
            const solicitud = solicitudes.find(s => String(s.id) === String(id));
            if (!solicitud) return;
            solicitud.estado = 'Pendiente';
            saveSolicitudesLocal();
            try {
                await updateCampoFirestore(solicitud.id, { estado: 'Pendiente' });
            } catch (e) {
                console.error(e);
            }
            updateStats();
            renderSolicitudes(document.getElementById('searchInput').value.toLowerCase());
        };

        window.eliminarSolicitud = async function(id) {
            if (!confirm('¬øEst√°s seguro de eliminar esta solicitud?')) return;
            solicitudes = solicitudes.filter(s => String(s.id) !== String(id));
            saveSolicitudesLocal();
            try {
                await deleteSolicitudFirestore(id);
            } catch (e) {
                console.error(e);
            }
            updateStats();
            renderSolicitudes(document.getElementById('searchInput').value.toLowerCase());
        };

        function exportToCSV() {
            if (solicitudes.length === 0) {
                alert('No hay solicitudes para exportar');
                return;
            }

            const headers = ['ID', 'C√≥digo', 'Tienda', 'Zona Tienda', 'Tipo', 'Zona Trabajo', 'Prioridad', 'Estado', 'Fecha', 'Solicitante', 'Responsable', 'Fecha L√≠mite', 'Descripci√≥n', 'Notas', 'Evidencias'];
            const rows = solicitudes.map(sol => [
                sol.id,
                sol.codigoTienda,
                sol.nombreTienda || 'N/A',
                sol.zonaTienda || sol.zona || 'N/A',
                sol.tipo,
                sol.zona,
                sol.prioridad,
                sol.estado,
                sol.fecha,
                sol.solicitante || 'N/A',
                sol.responsable || 'N/A',
                sol.fechaLimite || 'N/A',
                `"${(sol.descripcion || '').replace(/"/g, '""')}"`,
                `"${(sol.notas || '').replace(/"/g, '""')}"`,
                sol.evidencias && sol.evidencias.length > 0 ? sol.evidencias.length + ' im√°genes' : 'Sin evidencias'
            ]);

            let csvContent = headers.join(',') + '\n';
            rows.forEach(row => {
                csvContent += row.join(',') + '\n';
            });

            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `solicitudes_oxxo_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        document.getElementById('solicitudForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            console.log('ENVIANDO FORMULARIO');

            if (!selectedTiendaData) {
                alert('Por favor selecciona una tienda v√°lida de la lista');
                return;
            }
            
            const tiendaData = selectedTiendaData;
            const fileInput = document.getElementById('evidencia');
            const evidencias = [];

            const procesarArchivos = () => {
                return new Promise((resolve) => {
                    if (fileInput.files.length === 0) {
                        resolve([]);
                        return;
                    }

                    let processed = 0;
                    Array.from(fileInput.files).forEach(file => {
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            evidencias.push(event.target.result);
                            processed++;
                            if (processed === fileInput.files.length) {
                                resolve(evidencias);
                            }
                        };
                        reader.readAsDataURL(file);
                    });
                });
            };

            console.log('ANTES DE LEER IM√ÅGENES');
            const imagenesBase64 = await procesarArchivos();
            console.log('IM√ÅGENES LISTAS', imagenesBase64.length);

            const ahora = new Date();
            const nuevaSolicitud = {
                codigoTienda: tiendaData.codigo,
                nombreTienda: tiendaData.nombre,
                zonaTienda: tiendaData.zona,
                tipo: document.getElementById('tipoRequerimiento').value,
                zona: document.getElementById('zona').value,
                prioridad: document.getElementById('prioridad').value,
                descripcion: document.getElementById('descripcion').value,
                solicitante: document.getElementById('solicitante').value,
                responsable: document.getElementById('responsable').value || '',
                fechaLimite: document.getElementById('fechaLimite').value || 'Sin fecha l√≠mite',
                notas: document.getElementById('notas').value || '',
                evidencias: imagenesBase64,
                fecha: ahora.toLocaleDateString('es-MX'),
                fechaTimestamp: ahora.getTime(),
                estado: 'Pendiente',
                seguimiento: []
            };

            try {
                console.log('ANTES DE addDoc');
                const ref = await addDoc(solicitudesRef, nuevaSolicitud);
                console.log('DESPU√âS DE addDoc', ref.id);
            } catch (err) {
                console.error("Error guardando en Firestore, se queda solo local:", err);
                nuevaSolicitud.id = Date.now();
            }

            solicitudes.unshift(nuevaSolicitud);
            saveSolicitudesLocal();
            updateStats();
            renderSolicitudes(document.getElementById('searchInput').value.toLowerCase());

            e.target.reset();
            selectedTiendaData = null;
            document.getElementById('numTienda').value = '';
            document.getElementById('responsable').innerHTML = '<option value="">Seleccionar...</option>';

            const successMsg = document.getElementById('successMessage');
            successMsg.style.display = 'block';
            setTimeout(() => {
                successMsg.style.display = 'none';
            }, 3000);

            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        });

        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentFilter = this.dataset.filter;
                renderSolicitudes(document.getElementById('searchInput').value.toLowerCase());
            });
        });

        document.getElementById('searchInput').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            renderSolicitudes(searchTerm);
        });

        document.getElementById('exportBtn').addEventListener('click', exportToCSV);

        async function init() {
            try {
                await loadSolicitudesFirestore();
            } catch (e) {
                console.warn("No se pudo cargar desde Firestore, usando datos locales:", e);
                loadSolicitudesLocal();
            }
            updateStats();
            renderSolicitudes();
        }

        setupTiendaAutocomplete();
        document.getElementById('zona').addEventListener('change', actualizarResponsablePorZona);
        init();
    </script>
</body>
</html>
